---
title: "Product Controller"
chapter: true
weight: 8
---

![vFunction Logo](/images/vFunction.png)

### Product  Controller

ProductController calls InventoryController to support requests such as finding the inventory according to the product description. Here we will show how to refactor the code to support service to service calls.


1. Go to the ProductController project in Eclipse, and perform the steps described in section [Config Data Source](/200_refactoring-engine/210_servicecreation/5_db_config.html)

2. To set the service port (the default port 8080 has been taken by OrderController), open the application.properties file and add the property *server.port=8082*

3. Open the file src/main/java/com/oms/productcontroller/ProductControllerApp.java and add the annotation ```@EntityScan(basePackages = { "com.oms.entity" })``` with the required import to the application class as you did for [Order Controller](/200_refactoring-engine/210_servicecreation/6_order_controller.html) 

4. Open the class com.oms.service.ProductService. You should see errors related to InventoryService: We cannot continue to use InventoryService directly within ProductController, as this class was separated into the InventoryController service during the analysis. Instead, the ProductController should call the entry point of InventoryController, implemented by com.oms.inventorycontroller.InventoryServiceController in InventoryController (this class was generated by vFunction)

5. Open the pom.xml file of ProductController and add the dependency to WebFlux if it is missing. This is needed for using a web client to call the APIs of Inventory Controller.

```XML
<dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-webflux</artifactId>
</dependency>
```

6. Copy the package com.oms.inventorycontroller.dto from InventoryController to ProductController so ProductController can use the same Data Transfer Object (DTO) classes required by InventoryController http endpoint

    ![DTO Inventory Package](/images/DTO_package_eclipse.png)


7. Switch back to com.oms.service.ProductService class and delete the member *InventoryService inventoryService* (along with its @Autowired annotation)

8. Add a WebClient member to ProductService and initialize it to call the InventoryController service. Ensure the port is set correctly:

    ```java
    WebClient inventoryServiceClient = WebClient.create("http://localhost:8081");
    ```
    *Note that the required import statement is:*
    ```java 
    import org.springframework.web.reactive.function.client.WebClient;
    ```

9. Replace the implementation of getProductInventory(), so the Inventory related to the product will be brought by calling the InventoryController service over http

    ``` java
 	public Inventory getProductInventory(String pid) {
		logger.log(this.getClass().getName());
		InventoryServiceFetchInventoryInDTO inDTO = new InventoryServiceFetchInventoryInDTO();
		inDTO.setSkuId(pid);
		InventoryServiceFetchInventoryOutDTO outDTO = inventoryServiceClient.post()
				.uri("inventoryService/fetchInventory")
				.header(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
				.body(Mono.just(inDTO), InventoryServiceFetchInventoryInDTO.class).retrieve()
				.bodyToMono(InventoryServiceFetchInventoryOutDTO.class).block();

		return outDTO.getRetVal();
	}   
    ```

    *Note that the required import statements are:*
    ```java
    import com.oms.inventorycontroller.dto.InventoryServiceFetchInventoryInDTO;
    import com.oms.inventorycontroller.dto.InventoryServiceFetchInventoryOutDTO;
    import org.springframework.http.HttpHeaders;
    import org.springframework.http.MediaType;
    import reactor.core.publisher.Mono;
    ```

10. If needed, remove the import of com.oms.entity.ShippingService and any other code elements referencing ShippingService, as this was marked as dead-code in the analysis

11. Compile the ProductController service (Maven clean and then Maven install)

12. Run the OrderController service (if not already running) and create orders lines by sending the request Create Multiple Orders from Postman

13. Run the InventoryController (if not already running) and create inventory items by sending the request Create Multiple Inventory Items from Postman

14. Run the ProductController and send Create Products request from Postman to create the products

15. Send Find All Products request from Postman; the response should be a JSON containing the list of products

16. Send Find Inventory By Product Description request, the response should be a JSON object of all inventory items related to products containing iPhone in the description

17. Send Get Charges For Product - the result should be the amount charged for all orders made for the product with ID SM-S20-BLK (10.0)

![vFunction Logo](/images/vFunction.png)
